--- PYTHON & SQL ETL DEVELOPER-GNANESHWAR SRAVANE
USE Estimates

IF OBJECT_ID ('TEMPDB..#STDM1') IS NOT NULL DROP TABLE #STDM1
SELECT DISTINCT ct.relatedcompanyid AS CompanyId,stt.subTypeId,stt.subTypeValue,ed.effectiveDate,--ct.collectionEntityId AS VersionId,cet.collectionEntityTypeName AS EntityType,
cp.collectionProcessName AS CollectionProcess,cp.collectionProcessId,cs.collectionStageName AS CollectionStage,ct.collectionstageId,dim.dataItemID,CTI.IndustryName AS Industry,dim.flagEAG,cst.statusDescription AS StatusoftheCompamy INTO #STDM1
FROM          WorkflowArchive_Estimates.[dbo].CommonTracker_vw CT (NOLOCK)
LEFT JOIN     WorkflowArchive_Estimates.dbo.CollectionEntityToProcessToDataPoint_tbl ctdp (NOLOCK) ON ctdp.collectionEntityToProcessId=ct.collectionEntityToProcessId and ctdp.datapointId=1887
LEFT JOIN     Estimates.dbo.Estimates_IndustrySubTypeToCollectionProcess_tbl est (NOLOCK) ON est.industrySubTypeId=ctdp.value
LEFT JOIN     WorkflowArchive_Estimates.dbo.CollectionProcess_tbl cp (NOLOCK) ON cp.collectionProcessId=isnull(est.collectionProcessId,ct.collectionProcessId)
LEFT JOIN     Workflow_Estimates.[dbo].[CollectionStage_tbl] cs (NOLOCK) ON cs.collectionStageId=ct.collectionstageId
LEFT JOIN     Workflow_Estimates.[dbo].[CollectionStageStatus_tbl] css (NOLOCK) ON css.collectionStageStatusId=ct.collectionstageStatusId
LEFT JOIN     Estimates.[dbo].estimatedetail_tbl ed (NOLOCK) ON ct.collectionEntityId = ISNULL(ed.versionid,ed.feedFileId) AND CT.relatedCompanyId=ed.companyId
LEFT JOIN     ComparisonData.[dbo].[Company_tbl] ctl (NOLOCK) ON ct.relatedcompanyid = ctl.companyId
LEFT JOIN     Comparisondata.dbo.SubType_tbl stt (NOLOCK) ON stt.SubTypeId=ctl.PrimarySubTypeId
LEFT JOIN     CompanyMaster.[dbo].CompanyInfoMaster cm (NOLOCK) ON cm.CIQCompanyId=ct.relatedCompanyId
LEFT JOIN	  Workflow_Estimates.[dbo].[CTAdmin_Industries_vw] CTI (NOLOCK) ON cm.IndustryID = CTI.IndustryId
LEFT JOIN     Workflow_Estimates.[dbo].[CollectionEntityType_tbl] cet (NOLOCK) ON cet.collectionEntityTypeId=ct.collectionEntityTypeId
INNER JOIN    [EstFull_vw] ednd (NOLOCK) ON ednd.estimateDetailId=ed.estimateDetailId
INNER JOIN    DataItemMaster_vw dim (NOLOCK) ON dim.dataItemID=ednd.dataItemId
INNER JOIN    CompanyMaster.[dbo].[CompanyStatusType_tbl] cst (NOLOCK) ON cst.companyStatusTypeId=ctl.companyStatusTypeId
WHERE --ct.collectionEntityId IN (-2080906384,-2073305674,-2076024428)
ct.collectionstageId IN (2)
AND ct.collectionProcessId IN (64,1062,4861,4862,4863,4864,4899,4900,4901,4902,4903,4904,4905,4906,4907)
AND ct.collectionstageStatusId IN (4)
AND ct.relatedcompanyid IS NOT NULL
AND stt.subTypeId IN (2061000,3021000,3241000,4012000,4312000,5221000,7211000,8042000,8133000,8212000,9521000,9541000,9612009,9621063,9621091,9622304)
AND dim.dataItemID IN (602731,602724,602733,602734,602732,603290,603283,603292,603293,603291,115468,115461,115472,115473,115471,115442,115435,115446,115447,115445,115416,115409,115420,115421,115419,600301,600248,600405,600457,600353,602744,602737,602746,602747,602745,601370,601376,601377,601378,601379,601383,601389,601390,601391,601392,603329,603322,603331,603332,603330,603355,603348,603357,603358,603356,602757,602750,602759,602760,602758,602770,602763,602772,602773,602771,603433,603426,603435,603436,603434,600320,600267,600424,600476,600372,600308,600255,600412,600464,600360,603407,603400,603409,603410,603408,600319,600266,600423,600475,600371,604161,604154,604163,604164,604162,603316,603309,603318,603319,603317,602822,602815,602824,602825,602823,600300,600247,600404,600456,600352,601448,601454,601455,601456,601457,602848,602841,602850,602851,602849,604213,604206,604215,604216,604214,604252,604245,604254,604255,604253,600313,600260,600417,600469,600365,600324,600271,600428,600480,600376,115533,115526,115537,115538,115536,602861,602854,602863,602864,602862,600318,600265,600422,600474,600370,602874,602867,602876,602877,602875,600317,600264,600421,600473,600369,600311,600258,600415,600467,600363,602900,602893,602902,602903,602901,600323,600270,600427,600479,600375,602913,602906,602915,602916,602914,603446,603439,603448,603449,603447,600302,600249,600406,600458,600354,603459,603452,603461,603462,603460,600298,600245,600402,600454,600350,600315,600262,600419,600471,600367,602926,602919,602928,602929,602927,602939,602932,602941,602942,602940,602952,602945,602954,602955,602953,600299,600246,600403,600455,600351,600289,600236,600393,600445,600341,600312,600259,600416,600468,600364,600329,600277,600433,600485,600381,600307,600254,600411,600463,600359,600310,600257,600414,600466,600362,602978,602971,602980,602981,602979,600292,600239,600396,600448,600344,600290,600237,600394,600446,600342,602991,602984,602993,602994,602992,600296,600243,600400,600452,600348,603004,602997,603006,603007,603005,603017,603010,603019,603020,603018,604174,604167,604176,604177,604175,603342,603335,603344,603345,603343,603368,603361,603370,603371,603369,603043,603036,603045,603046,603044,603069,603062,603071,603072,603070,603082,603075,603084,603085,603083,600336,600284,600440,600492,600388,603381,603374,603383,603384,603382,603303,603296,603305,603306,603304,603121,603114,603123,603124,603122,115520,115513,115524,115525,115523,115507,115500,115511,115512,115510,115494,115487,115498,115499,115497,600305,600252,600409,600461,600357,603134,603127,603136,603137,603135,603147,603140,603149,603150,603148,600322,600269,600426,600478,600374,603173,603166,603175,603176,603174,603186,603179,603188,603189,603187,603199,603192,603201,603202,603200,600295,600242,600399,600451,600347,115481,115474,115485,115486,115484,603212,603205,603214,603215,603213,603394,603387,603396,603397,603395,115455,115448,115459,115460,115458,115429,115433,115434,115432,115422,115403,115396,115407,115408,115406,115591,115584,115595,115596,115594,603238,603231,603240,603241,603239,603251,603244,603253,603254,603252,603264,603257,603266,603267,603265,600309,600256,600413,600465,600361)
ORDER BY ct.relatedcompanyid


--SELECT * FROM #STDM1

IF OBJECT_ID ('TEMPDB..#SLA3') IS NOT NULL DROP TABLE #SLA3
SELECT DISTINCT CompanyId,subTypeId,subTypeValue,Industry,CollectionProcess AS Docs_moving_to_which_industry,collectionProcessId AS Docs_moving_to_which_industryID, 
StatusoftheCompamy,
CASE WHEN flagEAG IN ('E') THEN 'YES' ELSE 'NO' END AS Collected_Ind_Metrics_E,CASE WHEN flagEAG IN ('A') THEN 'YES' ELSE 'NO' END AS Collected_Ind_Metrics_A,
CASE WHEN flagEAG IN ('G') THEN 'YES' ELSE 'NO' END AS Collected_Ind_Metrics_G
INTO #SLA3 FROM #STDM1 
ORDER BY CompanyId

--SELECT * FROM #SLA3 WHERE CompanyId=293065


IF OBJECT_ID ('TEMPDB..#FF') IS NOT NULL DROP TABLE #FF
SELECT DISTINCT CompanyId,subTypeId,subTypeValue,Industry,Docs_moving_to_which_industry,Docs_moving_to_which_industryID, 
StatusoftheCompamy,MAX(Collected_Ind_Metrics_E) AS Collected_Ind_Metrics_EE,MAX(Collected_Ind_Metrics_A) AS Collected_Ind_Metrics_AA,MAX(Collected_Ind_Metrics_G) AS Collected_Ind_Metrics_GG 
INTO #FF FROM #SLA3
GROUP BY CompanyId,subTypeId,subTypeValue,Industry,Docs_moving_to_which_industry,Docs_moving_to_which_industryID,StatusoftheCompamy



SELECT DISTINCT * FROM #FF WHERE Collected_Ind_Metrics_EE = 'YES' OR Collected_Ind_Metrics_AA = 'YES' OR Collected_Ind_Metrics_GG = 'YES'
ORDER BY CompanyId

----Max filingdate by companyid & flagEAG

--IF OBJECT_ID('tempdb..#maxdate1') IS NOT NULL DROP TABLE #maxdate1 
--SELECT DISTINCT CompanyId,subTypeId,collectionProcessId,StatusoftheCompamy,dataItemID,flagEAG,MAX(effectivedate) AS MaxFilingDate INTO #maxdate1 FROM #STDM1 
--GROUP BY CompanyId,subTypeId,collectionProcessId,StatusoftheCompamy,dataItemID,flagEAG
--ORDER BY CompanyId

-----SELECT * FROM #maxdate1

--SELECT DISTINCT a.companyId,a.subTypeId,a.subTypeValue,a.CollectionProcess AS Docs_moving_to_which_industry,a.collectionProcessId AS Docs_moving_to_which_industryID, 
--a.StatusoftheCompamy,a.flagEAG,a.dataItemID,a.effectiveDate FROM #STDM1 a 
--INNER JOIN #maxdate1 b (NOLOCK) ON b.CompanyId=a.CompanyId AND b.subTypeId=a.subTypeId AND b.collectionProcessId=a.collectionProcessId AND b.flagEAG=a.flagEAG AND b.dataItemID=a.dataItemID
--WHERE b.MaxFilingDate=a.effectiveDate