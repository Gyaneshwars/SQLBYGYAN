--PYTHO,SQL,AZURE DATA FACTORY AND POWER BI ETL DEVELOPER --> GNANESHWAR SRAVANE
USE Pathfinder 
DECLARE @frDate DATETIME, @toDate DATETIME 
SET @frDate = '2024-01-01 00:00:00.000'
SET @toDate = '2024-04-30 23:59:00.000'

IF OBJECT_ID ('TEMPDB..#QueuedPF') IS NOT NULL DROP TABLE #QueuedPF
SELECT DISTINCT IPI.ProcessInstanceAppianID,IPI.ProcessInstanceInstantiated,IPI.ProcessInstanceCompleted,IPI.ProcessInstanceTargetDate,IPI.ProcessInstanceSLADate,
IPS.KeyProcessOwner,IPS.KeyProcessStream,IPS.StreamName,IPS.ActiveProcessStream,TI.KeyPerson,PT.ProcessInstanceName,TI.SNLAnalystTaskEntry,TI.TaskInstanceAppianID,TI.TaskInstanceBegun,TI.TaskInstanceCompleted,
TI.TaskInstanceInstantiated,TI.TaskName,TI.TaskRework,TI.TaskReworkApprover,PT.PersonNameWorked,PT.TaskDisplayName,PF.EmployeeFullName,PF.SupervisorFullName,PN.INTERNALNOTES,PDV.FIELDIDENTIFIER,PDV.PROCESSFIELDVALUE,IPI.ProcessInstanceDescription
INTO #QueuedPF  FROM PROCESSINSTANCE IPI
FULL JOIN DBO.[PROCESSSTREAM] IPS (NOLOCK) ON IPI.KEYPROCESSSTREAM = IPS.KEYPROCESSSTREAM
FULL JOIN DBO.[PROCESSSTREAMGROUP] PG (NOLOCK) ON PG.KEYPROCESSSTREAM=IPS.KEYPROCESSSTREAM
FULL JOIN DBO.[ProcessDataValue] PDV (NOLOCK) ON pdv.KeyProcessInstance=ipi.KeyProcessInstance
FULL JOIN DBO.[taskinstance] TI (NOLOCK) ON TI.keyprocessinstance=ipi.keyprocessinstance
FULL JOIN InternalUseOnly.[dbo].[PFEmployee] PF (NOLOCK) ON PF.KeyPerson=TI.KeyPerson
FULL JOIN DBO.[TaskInstanceContentMetric] TICM (NOLOCK) ON TI.[KeyTaskInstance]=TICM.[KeyTaskInstance]
FULL JOIN DBO.[ProcessNotes] PN (NOLOCK) ON PN.KeyProcessInstance=ipi.KeyProcessInstance
FULL JOIN InternalUseOnly.DBO.[PFEmployee] P (NOLOCK) ON TI.KEYPERSON = P.KEYPERSON
FULL JOIN DBO.[PFJobs] PFJ (NOLOCK) ON PFJ.ProcessInstanceAppianID = IPI.ProcessInstanceAppianID
FULL JOIN DBO.[PFTask] PT (NOLOCK) ON PFJ.PROCESSINSTANCEAPPIANID = PT.ProcessInstanceAppianId AND TI.KEYPROCESSINSTANCE = PT.KEYPROCESSINSTANCE
WHERE IPI.keyprocessstream IN (22169)---(21820,21850,21851,21853,22138,23785,23845,23847,23900,24004,24018,25614,28419,28420,28430,28605,29435,48402,48405,52128,52310,52380,52811,53168,53446,54387,55097,57903,57904,58117,58287,58292,58293,24395,24396,24397,24398,24415,24416,24417,24418,48226,48481,53719,58272,58273,21909,21910,22070,22139,22140,22141,22149,22150,22151,22152,22153,22156,22157,22158,22160,22161,22163,22165,22168,22169,22170,22172,22180,22181,22183,22184,22185,22662,23887,23889,23890,23892,23893,31157,48999,52463,53139,53194,53199,53470,53489,53490,54760,56244,56632,58732,59244)
AND IPI.ProcessInstanceInstantiated > @frDate
AND IPI.ProcessInstanceInstantiated < @toDate
AND IPI.ProcessInstanceCompleted IS NULL
AND IPI.UpdOperation<>2


--SELECT * FROM #QueuedPF

SELECT DISTINCT * FROM #QueuedPF PIVOT (MAX(PROCESSFIELDVALUE) FOR FIELDIDENTIFIER IN
(PEO,ERD,DataItem,Industry,Assignee,MethodologyExclusions,CompanyName,Peak,CompanyId,emailSubject,fromName)) AS PathPIVOT


USE Pathfinder
select distinct PDV.FIELDIDENTIFIER from  PROCESSINSTANCE IPI
INNER JOIN PROCESSSTREAM IPS ON IPI.KEYPROCESSSTREAM = IPS.KEYPROCESSSTREAM 
JOIN DBO.PROCESSDATAVALUE PDV ON PDV.KEYPROCESSINSTANCE=IPI.KEYPROCESSINSTANCE
where IPS.KEYPROCESSSTREAM in (21820,21850,21851,21853,22138,23785,23845,23847,23900,24004,24018,25614,28419,28420,28430,28605,29435,48402,48405,52128,52310,52380,52811,53168,53446,54387,55097,57903,57904,58117,58287,58292,58293,24395,24396,24397,24398,24415,24416,24417,24418,48226,48481,53719,58272,58273,21909,21910,22070,22139,22140,22141,22149,22150,22151,22152,22153,22156,22157,22158,22160,22161,22163,22165,22168,22169,22170,22172,22180,22181,22183,22184,22185,22662,23887,23889,23890,23892,23893,31157,48999,52463,53139,53194,53199,53470,53489,53490,54760,56244,56632,58732,59244)AND IPS.KEYDEPARTMENT = 143






































--IF OBJECT_ID ('TEMPDB..#Finals') IS NOT NULL DROP TABLE #Finals
--SELECT DISTINCT ProcessInstanceInstantiated,CASE WHEN KEYPERSON IS NULL AND TASKINSTANCEBEGUN IS NULL AND TaskInstanceCompleted IS NULL THEN 'ACTIVE' WHEN KEYPERSON IS NOT NULL AND TASKINSTANCEBEGUN IS NOT NULL AND TaskInstanceCompleted IS NULL THEN 'PAUSED'  ELSE 'COMPLETED' END AS JobStatus,PROCESSINSTANCEAPPIANID AS JobID,KEYPROCESSSTREAM,STREAMNAME AS Process_Stream,taskname, ----,ProcessInstanceName AS JobName
--KEYPERSON,PersonNameWorked ,SupervisorFullName,TASKINSTANCEBEGUN,TaskInstanceCompleted,PROCESSINSTANCETARGETDATE AS GoalDate, 
--SNLANALYSTTASKENTRY INTO #Finals FROM #QueuedPF PIVOT (MAX(PROCESSFIELDVALUE) FOR FIELDIDENTIFIER IN 
--(PEO,ERD,DataItem,Industry,Assignee,MethodologyExclusions,CompanyName,Peak,CompanyId,emailSubject,fromName))AS PathPIVOT



--SELECT * FROM #Finals WHERE JobStatus IN ('ACTIVE','PAUSED') 
--ORDER BY ProcessInstanceInstantiated